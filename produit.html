<!doctype html>
<html lang="fr">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  <link rel="stylesheet" href="css/style.css">

  <title>Votre produit</title>
</head>

<body>
  <header>
    <nav>
      <ul class="list-unstyled">
        <li><a href="index.html">Accueil</a>
        </li>
        <li><a href="panier.html">Panier <div>
              <p id="contenuPanier"></p>
            </div></a></li>
      </ul>
    </nav>

    <h1>Votre Produit</h1>
  </header>

  <main>
    <div class="container">
      <div class="col-12">
        <div class="row">

          <div class="col-6">
            <img src="" id="imageProduit" />
          </div>

          <div class="col-6">
            <div class="row">
              <ul class="col- 12 list-unstyled">
                <li id="name"></li>
                <li>
                  <div id="price"></div>
                  <div>€</div>
                </li>
                <li id="description"></li>
              </ul>
              <div class="col-12">
                <div>
                  <p>Vernis :</p>
                  <p id="vernisChoisi"></p>
                </div>
                <form action="customise">
                  <label for="optionsCustomise"> Sélectionnez votre vernis : </label>
                  <select name="optionsCustomise" id="optionsCustomise">

                  </select>

                  <button type="submit" id="ajoutAuPanier"> Panier </button>


                </form>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer>

  </footer>


  <script defer>
    // Récupération de l'id dans l'URL
    let params = new URLSearchParams(document.location.search.substring(1));
    let productId = params.get("id");
    console.log(productId);

    // Récupération des éléments DOM
    let productName = document.getElementById("name");
    let productPrice = document.getElementById("price");
    let productDescription = document.getElementById("description");
    let productCustomise = document.getElementById("optionsCustomise");
    let productImage = document.getElementById("imageProduit");
    let productVernis = document.getElementById("vernisChoisi");

    // Récupération de l'API et intégration des données dans le document HTML.
    var request = new XMLHttpRequest();
    request.onreadystatechange = function () {
      if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
        var response = JSON.parse(this.responseText);

        console.log(response);
        productName.innerHTML = response.name;
        productImage.setAttribute("src", `${response.imageUrl}`);
        productPrice.innerHTML = response.price/100;
        productDescription.innerHTML = response.description;
        productVernis.innerHTML = response.varnish[0];

        let nbOptions = response.varnish;
        for (let j in nbOptions) {
          let newOption = document.createElement("option");
          optionsCustomise.appendChild(newOption);
          newOption.innerHTML = response.varnish[j];
          newOption.setAttribute("value", `${j}`);
          newOption.setAttribute("class", "optionVernis");
          if (j == 0) {
            newOption.setAttribute("selected", "");
          };
        };

      };
    };
    request.open("GET", `http://localhost:3000/api/furniture/${productId}`);
    request.send();



    //Création de la commande :
    let commande = [];


    // Initalisation du nombre de produit dans le paniers.
    var panierEffectif;

    // Définition de l'affichage du nombre de produits dans le panier.
    panierEffectif = localStorage.nbCommandes;
    if (localStorage.nbCommandes == undefined) {
      localStorage.nbCommandes = 0;
    };
    let nbCommandes = document.getElementById("contenuPanier");
    nbCommandes.innerHTML = localStorage.nbCommandes;


    // Clic sur le panier : Ajout de la commande dans le localStorage, incrémentation du nombre de produits.
    document.getElementById("ajoutAuPanier").addEventListener("click", function (e) {
      e.preventDefault();
      if (panierEffectif == 0) {            //Incrémentation du nombre, affichage, puis stockage dans le Storage.
        panierEffectif++;
        nbCommandes.innerHTML = panierEffectif;
        localStorage.setItem("nbCommandes", `${panierEffectif}`);
      } else if (panierEffectif > 0) {
        panierEffectif++;
        nbCommandes.innerHTML = panierEffectif;
        localStorage.setItem("nbCommandes", `${panierEffectif}`);
      }
      if (localStorage.commande) {         //on récupère l'Array de la commande que l'on convertit en Js pour être utilisable.
        commande = JSON.parse(localStorage.commande);
      };
       
      const item = new Object();           //on crée un nouveau produit que l'on ajoute à la commande.
      item.id = productId;
      item.vernis = productCustomise.value;
      item.prix = productPrice.innerHTML;
      item.name = productName.innerHTML;
      console.log(commande);
      commande.push(item);

      let commandeToStorage = JSON.stringify(commande); //on envoie les données au Storage.
      localStorage.setItem("commande", `${commandeToStorage}`);

    });




  </script>



</body>

</html>